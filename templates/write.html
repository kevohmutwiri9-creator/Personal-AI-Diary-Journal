{% extends "base.html" %}

{% block title %}Write Entry - My Diary{% endblock %}

{% block content %}
<div class="write-page">
    <h1><i class="fas fa-pen"></i> Write a New Diary Entry</h1>
    <p class="write-subtitle">Express your thoughts and feelings</p>
    
    <form method="POST" class="entry-form">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="form-row">
            <div class="form-group">
                <label for="title" class="form-label">Title (Optional)</label>
                <input 
                    type="text" 
                    id="title" 
                    name="title" 
                    class="form-input" 
                    placeholder="Give your entry a title..."
                    maxlength="200"
                >
            </div>
            
            <div class="form-group">
                <label for="category_id" class="form-label">Category</label>
                <select id="category_id" name="category_id" class="form-input">
                    <option value="">Select a category...</option>
                    {% for category in categories %}
                        <option value="{{ category.id }}" style="color: {{ category.color }};">
                            {{ category.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="mood" class="form-label">Mood</label>
                <select id="mood" name="mood" class="form-input">
                    <option value="">How are you feeling?</option>
                    <option value="😊 Happy">😊 Happy</option>
                    <option value="😢 Sad">😢 Sad</option>
                    <option value="😴 Tired">😴 Tired</option>
                    <option value="🤔 Thoughtful">🤔 Thoughtful</option>
                    <option value="😤 Frustrated">😤 Frustrated</option>
                    <option value="😌 Peaceful">😌 Peaceful</option>
                    <option value="🎉 Excited">🎉 Excited</option>
                    <option value="😰 Anxious">😰 Anxious</option>
                    <option value="😍 Loved">😍 Loved</option>
                    <option value="😔 Melancholy">😔 Melancholy</option>
                    <option value="🔥 Motivated">🔥 Motivated</option>
                    <option value="😌 Content">😌 Content</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="weather" class="form-label">Weather</label>
                <select id="weather" name="weather" class="form-input">
                    <option value="">What's the weather like?</option>
                    <option value="☀️ Sunny">☀️ Sunny</option>
                    <option value="⛅ Partly Cloudy">⛅ Partly Cloudy</option>
                    <option value="☁️ Cloudy">☁️ Cloudy</option>
                    <option value="🌧️ Rainy">🌧️ Rainy</option>
                    <option value="⛈️ Stormy">⛈️ Stormy</option>
                    <option value="❄️ Snowy">❄️ Snowy</option>
                    <option value="🌤️ Clear">🌤️ Clear</option>
                    <option value="🌫️ Foggy">🌫️ Foggy</option>
                </select>
            </div>
        </div>
        
        <div class="form-group">
            <label for="template_id" class="form-label">Use Template (Optional)</label>
            <select id="template_id" name="template_id" class="form-input" onchange="loadTemplate()">
                <option value="">Select a template to get started...</option>
                {% for template in user_templates %}
                    <option value="{{ template.id }}" data-content="{{ template.content | tojson | safe }}" data-title="{{ template.name | tojson | safe }}">
                        {{ template.name }}
                    </option>
                {% endfor %}
            </select>
            <small class="form-help">Choose a saved template to help you start writing</small>
        </div>
        
        <div class="form-group">
            <label for="tags" class="form-label">Tags (Optional)</label>
            <input 
                type="text" 
                id="tags" 
                name="tags" 
                class="form-input" 
                placeholder="Enter tags separated by commas (e.g., work, travel, family)"
            <small class="form-help">Tags help you organize and find your entries later</small>
        </div>
        
        <div class="form-group">
            <label for="content" class="form-label">What's on your mind?</label>

            <!-- Rich Text Editor Toolbar -->
            <div class="editor-toolbar">
                <button type="button" onclick="formatText('bold')" class="toolbar-btn" title="Bold">
                    <i class="fas fa-bold"></i>
                </button>
                <button type="button" onclick="formatText('italic')" class="toolbar-btn" title="Italic">
                    <i class="fas fa-italic"></i>
                </button>
                <button type="button" onclick="formatText('underline')" class="toolbar-btn" title="Underline">
                    <i class="fas fa-underline"></i>
                </button>
                <div class="toolbar-separator"></div>
                <button type="button" onclick="formatText('insertUnorderedList')" class="toolbar-btn" title="Bullet List">
                    <i class="fas fa-list-ul"></i>
                </button>
                <button type="button" onclick="formatText('insertOrderedList')" class="toolbar-btn" title="Numbered List">
                    <i class="fas fa-list-ol"></i>
                </button>
                <div class="toolbar-separator"></div>
                <button type="button" onclick="formatText('justifyLeft')" class="toolbar-btn" title="Align Left">
                    <i class="fas fa-align-left"></i>
                </button>
                <button type="button" onclick="formatText('justifyCenter')" class="toolbar-btn" title="Align Center">
                    <i class="fas fa-align-center"></i>
                </button>
                <button type="button" onclick="formatText('justifyRight')" class="toolbar-btn" title="Align Right">
                    <i class="fas fa-align-right"></i>
                </button>
            </div>

            <div
                id="content-editor"
                class="rich-editor"
                contenteditable="true"
                placeholder="Write your thoughts, feelings, experiences, or anything you'd like to remember..."
                required
            ></div>
            <input type="hidden" id="content" name="content">

            <div class="form-helpers">
                <small class="char-count">
                    <span id="charCount">0</span> / 10,000 characters
                </small>
                <small class="word-count">
                    <span id="wordCount">0</span> words
                </small>
            </div>
        </div>
        <div class="form-group">
            <label class="checkbox-label">
                <input type="checkbox" name="is_private" checked>
                <span class="checkmark"></span>
                Keep this entry private
            </label>
        </div>
        
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="previewEntry()">
                <i class="fas fa-eye"></i> Preview
            </button>
            <button type="submit" class="btn">
                <i class="fas fa-save"></i> Save Entry
            </button>
            <a href="{{ url_for('templates') }}" class="btn btn-secondary">
                <i class="fas fa-file-alt"></i> Templates
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Cancel
            </a>
        </div>
    </form>
    
    <div class="writing-tips">
        <h3><i class="fas fa-lightbulb"></i> Writing Tips</h3>
        <ul>
            <li>Write freely without worrying about grammar or structure</li>
            <li>Include your emotions and how you felt about events</li>
            <li>Describe details that might seem small but are meaningful to you</li>
            <li>Don't feel pressured to write every day - write when you feel like it</li>
            <li>Use categories and tags to organize your thoughts</li>
            <li>Track your mood to see patterns over time</li>
        </ul>
    </div>
</div>

<!-- Preview Modal -->
<div id="previewModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-eye"></i> Entry Preview</h3>
            <button onclick="closePreview()" class="close-btn">&times;</button>
        </div>
        <div id="previewContent" class="modal-body">
            <!-- Preview content will be inserted here -->
        </div>
        <div class="modal-footer">
            <button onclick="closePreview()" class="btn btn-secondary">Close</button>
        </div>
    </div>
</div>

<style>
    .write-page h1 {
        text-align: center;
        margin-bottom: 10px;
        color: #333;
    }

    .dark-mode .write-page h1 {
        color: #ecf0f1;
    }

    .write-subtitle {
        text-align: center;
        color: #666;
        margin-bottom: 40px;
        font-style: italic;
    }

    .dark-mode .write-subtitle {
        color: #bdc3c7;
    }

    .entry-form {
        background: rgba(255, 255, 255, 0.5);
        border-radius: 15px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .dark-mode .entry-form {
        background: rgba(44, 62, 80, 0.5);
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-help {
        display: block;
        margin-top: 5px;
        color: #666;
        font-size: 12px;
    }

    .dark-mode .form-help {
        color: #bdc3c7;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        font-weight: 500;
    }

    .checkbox-label input[type="checkbox"] {
        margin-right: 10px;
        transform: scale(1.2);
    }

    .form-helpers {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
    }

    .char-count, .word-count {
        color: #666;
        font-size: 12px;
    }

    .dark-mode .char-count, .dark-mode .word-count {
        color: #bdc3c7;
    }

    .form-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-top: 30px;
    }

    .writing-tips {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .dark-mode .writing-tips {
        background: rgba(44, 62, 80, 0.3);
    }

    .writing-tips h3 {
        margin-bottom: 15px;
        color: #333;
        text-align: center;
    }

    .dark-mode .writing-tips h3 {
        color: #ecf0f1;
    }

    .writing-tips ul {
        list-style: none;
        padding: 0;
    }

    .writing-tips li {
        padding: 8px 0;
        color: #666;
        position: relative;
        padding-left: 25px;
    }

    .writing-tips li:before {
        content: "💡";
        position: absolute;
        left: 0;
    }

    .dark-mode .writing-tips li {
        color: #bdc3c7;
    }

    /* Rich Text Editor Styles */
    .editor-toolbar {
        display: flex;
        gap: 5px;
        padding: 10px;
        background: rgba(102, 126, 234, 0.1);
        border-radius: 8px;
        margin-bottom: 10px;
        flex-wrap: wrap;
    }

    .dark-mode .editor-toolbar {
        background: rgba(52, 152, 219, 0.1);
    }

    .toolbar-btn {
        background: none;
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 5px;
        padding: 8px 10px;
        color: #667eea;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .toolbar-btn:hover {
        background: #667eea;
        color: white;
    }

    .dark-mode .toolbar-btn {
        border-color: rgba(52, 152, 219, 0.3);
        color: #3498db;
    }

    .dark-mode .toolbar-btn:hover {
        background: #3498db;
        color: white;
    }

    .toolbar-separator {
        width: 1px;
        background: rgba(102, 126, 234, 0.3);
        margin: 0 5px;
    }

    .dark-mode .toolbar-separator {
        background: rgba(52, 152, 219, 0.3);
    }

    .rich-editor {
        min-height: 300px;
        padding: 15px;
        border: 1px solid rgba(102, 126, 234, 0.3);
        border-radius: 8px;
        background: white;
        font-family: 'Poppins', sans-serif;
        font-size: 1rem;
        line-height: 1.6;
        outline: none;
        overflow-y: auto;
    }

    .rich-editor:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
    }

    .dark-mode .rich-editor {
        background: #2c3e50;
        color: #ecf0f1;
        border-color: rgba(52, 152, 219, 0.3);
    }

    .dark-mode .rich-editor:focus {
        border-color: #3498db;
        box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    .rich-editor:empty:before {
        content: attr(placeholder);
        color: #999;
        pointer-events: none;
    }

    .dark-mode .rich-editor:empty:before {
        color: #bdc3c7;
    }

    @media (max-width: 768px) {
        .form-row {
            grid-template-columns: 1fr;
        }

        .form-actions {
            flex-direction: column;
            align-items: center;
        }

        .form-helpers {
            flex-direction: column;
            gap: 5px;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const editor = document.getElementById('content-editor');
        const hiddenInput = document.getElementById('content');
        const charCount = document.getElementById('charCount');
        const wordCount = document.getElementById('wordCount');
        const titleInput = document.getElementById('title');
        
        // Load template content if provided
        const templateContent = '{{ template_content | tojson | safe }}';
        const templateTitle = '{{ template_title | tojson | safe }}';
        
        if (templateContent && templateContent !== '""') {
            editor.innerHTML = templateContent;
            updateCounts();
        }
        
        if (templateTitle && templateTitle !== '""') {
            titleInput.value = templateTitle;
        }
        
        // Restore saved draft (but not if using template)
        if (!templateContent || templateContent === '""') {
            const savedDraft = localStorage.getItem('diaryDraft');
            if (savedDraft) {
                editor.innerHTML = savedDraft;
                updateCounts();
            }
        }
        
        function updateCounts() {
            const text = editor.textContent || editor.innerText || '';
            const charCountValue = text.length;
            const wordCountValue = text.trim() ? text.trim().split(/\s+/).length : 0;
            
            charCount.textContent = charCountValue;
            wordCount.textContent = wordCountValue;
            
            // Color coding for character count
            if (charCountValue > 9500) {
                charCount.style.color = '#e74c3c';
            } else if (charCountValue > 8000) {
                charCount.style.color = '#f39c12';
            } else {
                charCount.style.color = '#666';
            }
        }
        
        // Auto-save draft
        editor.addEventListener('input', function() {
            hiddenInput.value = editor.innerHTML;
            localStorage.setItem('diaryDraft', editor.innerHTML);
            updateCounts();
        });
        
        // Clear draft on successful submit
        document.querySelector('form').addEventListener('submit', function() {
            localStorage.removeItem('diaryDraft');
        });
        
        // Initial count update
        updateCounts();
    });

    // Rich text editor functions
    function formatText(command) {
        document.execCommand(command, false, null);
        document.getElementById('content-editor').focus();
    }

    // Preview functionality
    function previewEntry() {
        const title = document.getElementById('title').value;
        const content = document.getElementById('content-editor').innerHTML;
        const category = document.getElementById('category_id');
        const categoryName = category.options[category.selectedIndex].text;
        const mood = document.getElementById('mood').value;
        const weather = document.getElementById('weather').value;
        const location = document.getElementById('location').value;
        const tags = document.getElementById('tags').value;

        let previewHTML = `
            <h3>${title || 'Untitled Entry'}</h3>
            <p><strong>Date:</strong> ${new Date().toLocaleDateString()}</p>
            ${categoryName !== 'Select a category...' ? `<p><strong>Category:</strong> ${categoryName}</p>` : ''}
            ${mood ? `<p><strong>Mood:</strong> ${mood}</p>` : ''}
            ${weather ? `<p><strong>Weather:</strong> ${weather}</p>` : ''}
            ${location ? `<p><strong>Location:</strong> ${location}</p>` : ''}
            ${tags ? `<p><strong>Tags:</strong> ${tags}</p>` : ''}
            <hr>
            <div>${content}</div>
        `;

        document.getElementById('previewContent').innerHTML = previewHTML;
        document.getElementById('previewModal').style.display = 'block';
    }

    function closePreview() {
        document.getElementById('previewModal').style.display = 'none';
    }

    // Load template content when template is selected
    function loadTemplate() {
        const templateSelect = document.getElementById('template_id');
        const selectedOption = templateSelect.options[templateSelect.selectedIndex];

        if (selectedOption.value) {
            const templateContent = selectedOption.getAttribute('data-content');
            const templateTitle = selectedOption.getAttribute('data-title');

            if (templateContent) {
                // Parse the JSON-encoded content
                const content = JSON.parse(templateContent);
                document.getElementById('content-editor').innerHTML = content;

                // Update title if template has one
                if (templateTitle && templateTitle !== '""') {
                    document.getElementById('title').value = JSON.parse(templateTitle);
                }

                // Update character and word counts
                updateCounts();

                // Show confirmation
                if (!document.getElementById('templateLoadedMessage')) {
                    const message = document.createElement('div');
                    message.id = 'templateLoadedMessage';
                    message.className = 'template-loaded-message';
                    message.innerHTML = '<i class="fas fa-check-circle"></i> Template loaded! You can edit it as needed.';
                    message.style.cssText = `
                        background: rgba(39, 174, 96, 0.1);
                        color: #27ae60;
                        padding: 10px 15px;
                        border-radius: 8px;
                        margin-bottom: 15px;
                        border: 1px solid rgba(39, 174, 96, 0.2);
                        font-size: 0.9rem;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    `;

                    const form = document.querySelector('.entry-form');
                    form.insertBefore(message, form.firstChild);

                    // Auto-remove after 3 seconds
                    setTimeout(() => {
                        if (message.parentNode) {
                            message.remove();
                        }
                    }, 3000);
                }
            }
        }
    }
</script>
{% endblock %}
