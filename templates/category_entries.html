{% extends "base.html" %}

{% block title %}{{ category.name }} - Category Entries - My Diary{% endblock %}

{% block content %}
<div class="category-entries-page">
    <div class="category-header">
        <h1><i class="fas fa-tag" style="color: {{ category.color }};"></i> {{ category.name }}</h1>
        <p class="category-description">Entries in this category</p>

        <div class="category-info">
            <span class="category-color" style="background-color: {{ category.color }};"></span>
            <span class="entry-count">{{ entries|length }} entries</span>
        </div>
    </div>

    <div class="category-actions">
        <a href="{{ url_for('categories') }}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Categories
        </a>
        <a href="{{ url_for('write') }}" class="btn">
            <i class="fas fa-plus"></i> Add Entry to This Category
        </a>
    </div>

    {% if entries %}
        <div class="entries-section">
            <h2><i class="fas fa-book"></i> Entries in {{ category.name }}</h2>

            <div class="entries-grid">
                {% for entry in entries %}
                    <div class="entry-card {% if entry.is_favorite %}favorite-entry{% endif %}" data-aos="fade-up" data-aos-delay="{{ loop.index * 100 }}">
                        <div class="entry-header">
                            <div class="entry-date-time">
                                <span class="entry-date">
                                    <i class="fas fa-calendar"></i>
                                    {{ entry.timestamp.strftime('%B %d, %Y') if entry.timestamp else 'No date' }}
                                </span>
                                <span class="entry-time">
                                    <i class="fas fa-clock"></i>
                                    {{ entry.timestamp.strftime('%I:%M %p') if entry.timestamp else '' }}
                                </span>
                            </div>
                            <button class="favorite-btn" onclick="toggleFavorite({{ entry.id }}, this)" title="{% if entry.is_favorite %}Unpin{% else %}Pin{% endif %} entry" aria-label="{% if entry.is_favorite %}Unpin{% else %}Pin{% endif %} entry">
                                <i class="{% if entry.is_favorite %}fas{% else %}far{% endif %} fa-star"></i>
                            </button>
                        </div>

                        {% if entry.title %}
                            <h3 class="entry-title">{{ entry.title }}</h3>
                        {% endif %}

                        <div class="entry-preview">
                            {{ entry.content[:150] }}{% if entry.content|length > 150 %}...{% endif %}
                        </div>

                        <div class="entry-meta">
                            {% if entry.mood %}
                                <span class="entry-mood">
                                    <i class="fas fa-smile"></i> {{ entry.mood }}
                                </span>
                            {% endif %}
                            {% if entry.weather %}
                                <span class="entry-weather">
                                    <i class="fas fa-cloud"></i> {{ entry.weather }}
                                </span>
                            {% endif %}
                            {% if entry.word_count %}
                                <span class="entry-word-count">
                                    <i class="fas fa-file-word"></i> {{ entry.word_count }} words
                                </span>
                            {% endif %}
                        </div>

                        <div class="entry-actions">
                            <a href="{{ url_for('view_entry', entry_id=entry.id) }}" class="btn btn-small">
                                <i class="fas fa-eye"></i> View
                            </a>
                            <a href="{{ url_for('edit_entry', entry_id=entry.id) }}" class="btn btn-small">
                                <i class="fas fa-edit"></i> Edit
                            </a>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% else %}
        <div class="no-entries">
            <i class="fas fa-inbox"></i>
            <h3>No entries in {{ category.name }}</h3>
            <p>Start writing in this category to see your entries here!</p>
            <a href="{{ url_for('write') }}" class="btn">
                <i class="fas fa-pen"></i> Write First Entry
            </a>
        </div>
    {% endif %}

    <div class="category-management">
        <h3><i class="fas fa-cog"></i> Category Management</h3>
        <div class="management-actions">
            <button class="btn btn-secondary" onclick="editCategory({{ category.id }}, '{{ category.name }}', '{{ category.color }}')">
                <i class="fas fa-edit"></i> Edit Category
            </button>
            <button class="btn btn-danger" onclick="deleteCategory({{ category.id }}, '{{ category.name }}')">
                <i class="fas fa-trash"></i> Delete Category
            </button>
        </div>
    </div>
</div>

<style>
    .category-entries-page {
        max-width: 1200px;
        margin: 0 auto;
    }

    .category-header {
        text-align: center;
        margin-bottom: 40px;
        padding: 30px;
        background: rgba(255, 255, 255, 0.5);
        border-radius: 20px;
        backdrop-filter: blur(10px);
    }

    .dark-mode .category-header {
        background: rgba(44, 62, 80, 0.5);
    }

    .category-header h1 {
        margin-bottom: 10px;
        font-size: 2.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 15px;
    }

    .category-description {
        color: #666;
        font-size: 1.2rem;
        margin-bottom: 20px;
    }

    .dark-mode .category-description {
        color: #bdc3c7;
    }

    .category-info {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin-top: 20px;
    }

    .category-color {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        border: 2px solid rgba(255, 255, 255, 0.5);
    }

    .entry-count {
        background: rgba(102, 126, 234, 0.1);
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: 600;
        color: #667eea;
    }

    .category-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin-bottom: 40px;
        flex-wrap: wrap;
    }

    .entries-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 25px;
        margin-bottom: 40px;
    }

    .entry-card {
        background: rgba(255, 255, 255, 0.9);
        border-radius: 20px;
        padding: 25px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
    }

    .entry-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    }

    .dark-mode .entry-card {
        background: rgba(44, 62, 80, 0.9);
        border-color: rgba(52, 152, 219, 0.3);
    }

    .entry-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .dark-mode .entry-header {
        border-bottom-color: rgba(255, 255, 255, 0.1);
    }

    .entry-title {
        color: #333;
        margin-bottom: 15px;
        font-size: 1.3rem;
        font-weight: 700;
    }

    .dark-mode .entry-title {
        color: #ecf0f1;
    }

    .entry-preview {
        line-height: 1.6;
        color: #555;
        margin-bottom: 20px;
        min-height: 60px;
    }

    .dark-mode .entry-preview {
        color: #bdc3c7;
    }

    .entry-meta {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .entry-mood, .entry-weather, .entry-word-count {
        background: rgba(102, 126, 234, 0.1);
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.9rem;
        color: #667eea;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .entry-actions {
        display: flex;
        gap: 10px;
        justify-content: center;
    }

    .no-entries {
        text-align: center;
        padding: 80px 20px;
        color: #666;
    }

    .dark-mode .no-entries {
        color: #bdc3c7;
    }

    .no-entries i {
        font-size: 5rem;
        margin-bottom: 25px;
        color: rgba(102, 126, 234, 0.3);
    }

    .no-entries h3 {
        margin-bottom: 15px;
        color: #333;
        font-size: 1.8rem;
    }

    .dark-mode .no-entries h3 {
        color: #ecf0f1;
    }

    .category-management {
        background: rgba(255, 255, 255, 0.5);
        border-radius: 15px;
        padding: 25px;
        margin-top: 40px;
        text-align: center;
        backdrop-filter: blur(10px);
    }

    .dark-mode .category-management {
        background: rgba(44, 62, 80, 0.5);
    }

    .category-management h3 {
        margin-bottom: 20px;
        color: #333;
    }

    .dark-mode .category-management h3 {
        color: #ecf0f1;
    }

    .management-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        flex-wrap: wrap;
    }

    @media (max-width: 768px) {
        .entries-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .category-actions {
            flex-direction: column;
            align-items: center;
        }

        .entry-meta {
            flex-direction: column;
            align-items: center;
        }

        .management-actions {
            flex-direction: column;
            align-items: center;
        }
    }
</style>

<script>
    function editCategory(id, name, color) {
        const newName = prompt('Enter new category name:', name);
        const newColor = prompt('Enter new color (hex code):', color);

        if (newName && newName !== name) {
            // Send edit request
            fetch(`/categories/${id}/edit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `name=${encodeURIComponent(newName)}&color=${encodeURIComponent(newColor || color)}&csrf_token=${document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || 'Failed to update category');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }
    }

    function deleteCategory(id, name) {
        if (confirm(`Are you sure you want to delete the category "${name}"? This will remove the category association from all entries but keep the entries themselves.`)) {
            fetch(`/categories/${id}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `csrf_token=${document.querySelector('meta[name="csrf-token"]')?.getAttribute('content')}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.href = '/categories';
                } else {
                    alert(data.message || 'Failed to delete category');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }
    }

    function toggleFavorite(entryId, button) {
        const icon = button.querySelector('i');
        const card = button.closest('.entry-card');

        // Get CSRF token from meta tag or form
        const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') ||
                      document.querySelector('input[name="csrf_token"]')?.value;

        fetch(`/toggle_favorite/${entryId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                ...(token && { 'X-CSRFToken': token })
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Toggle star icon with animation
                if (data.is_favorite) {
                    icon.classList.remove('far');
                    icon.classList.add('fas');
                    card.classList.add('favorite-entry');
                    button.title = 'Unpin entry';
                } else {
                    icon.classList.remove('fas');
                    icon.classList.add('far');
                    card.classList.remove('favorite-entry');
                    button.title = 'Pin entry';
                }
            } else {
                alert(data.message || 'Failed to update favorite status');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred. Please try again.');
        });
    }
</script>
{% endblock %}
